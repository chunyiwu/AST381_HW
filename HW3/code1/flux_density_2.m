function [Pin_total] = flux_density_2(R_star,T_star,r_orb,fnum)
%%
% flux_density
%
% Plot the flux-calibrated spectrum of a star from certain distance.
%
% INPUT
% R_star - [double] body radius of star [R_sun]
% T_star - [double] temperature of star [K]
% r_orb  - [double] orbital radius of secondary object [AU]
%
% OUTPUT
% Pin_total - [double] total power in
%
% AUTHOR
% Chun-Yi Wu

%% Constants/parameters
% kB = 1.38064852e-16;    % Boltzmann constant [erg/K]
% h  = 6.626070040e-27;   % Planck constant [erg-s]
% c  = 299792458000;      % speed of light in vacuum [cm/s]

kB = 1.380658e-16;
c = 3e10;
h = 6.6260755e-27;

R_sun = 6.957e8;        % solar radius [m]
AU = 149597870700;      % astronomical unit [m]

%% Convert inputs to SI units
R_star = R_star * R_sun;
r_orb = r_orb * AU;

%% Find spectral flux at surface of star
lambdas = [1000;944;891;841;794;750;708;668;631;596;562;531;501;473;447;422;398;376;355;335;316;299;282;266;251;237;224;211;200;188;178;168;159;150;141;133;126;119;112;106;100;94.4000000000000;89.1000000000000;84.1000000000000;79.4000000000000;75;70.8000000000000;66.8000000000000;63.1000000000000;59.6000000000000;56.2000000000000;53.1000000000000;50.1000000000000;47.3000000000000;44.7000000000000;42.2000000000000;39.8000000000000;37.6000000000000;35.5000000000000;33.5000000000000;31.6000000000000;29.9000000000000;28.2000000000000;26.6000000000000;25.1000000000000;23.7000000000000;22.4000000000000;21.1000000000000;20;18.8000000000000;17.8000000000000;16.8000000000000;15.9000000000000;15;14.1000000000000;13.3000000000000;12.6000000000000;11.9000000000000;11.2000000000000;10.6000000000000;10;9.44000000000000;8.91000000000000;8.41000000000000;7.94000000000000;7.50000000000000;7.08000000000000;6.68000000000000;6.31000000000000;5.96000000000000;5.62000000000000;5.31000000000000;5.01000000000000;4.73000000000000;4.47000000000000;4.22000000000000;3.98000000000000;3.76000000000000;3.55000000000000;3.35000000000000;3.16000000000000;2.99000000000000;2.82000000000000;2.66000000000000;2.51000000000000;2.37000000000000;2.24000000000000;2.11000000000000;2;1.88000000000000;1.78000000000000;1.68000000000000;1.59000000000000;1.50000000000000;1.41000000000000;1.33000000000000;1.26000000000000;1.19000000000000;1.12000000000000;1.06000000000000;1;0.944000000000000;0.891000000000000;0.841000000000000;0.794000000000000;0.750000000000000;0.708000000000000;0.668000000000000;0.631000000000000;0.596000000000000;0.562000000000000;0.531000000000000;0.501000000000000;0.473000000000000;0.447000000000000;0.422000000000000;0.398000000000000;0.376000000000000;0.355000000000000;0.335000000000000;0.316000000000000;0.299000000000000;0.282000000000000;0.266000000000000;0.251000000000000;0.237000000000000;0.224000000000000;0.211000000000000;0.200000000000000;0.188000000000000;0.178000000000000;0.168000000000000;0.159000000000000;0.150000000000000;0.141000000000000;0.133000000000000;0.126000000000000;0.119000000000000;0.112000000000000;0.106000000000000;0.100000000000000;0.0944000000000000;0.0891000000000000;0.0841000000000000;0.0794000000000000;0.0750000000000000;0.0708000000000000;0.0668000000000000;0.0631000000000000;0.0596000000000000;0.0562000000000000;0.0531000000000000;0.0501000000000000;0.0473000000000000;0.0447000000000000;0.0422000000000000;0.0398000000000000;0.0376000000000000;0.0355000000000000;0.0335000000000000;0.0316000000000000;0.0299000000000000;0.0282000000000000;0.0266000000000000;0.0251000000000000;0.0237000000000000;0.0224000000000000;0.0211000000000000;0.0200000000000000;0.0188000000000000;0.0178000000000000;0.0168000000000000;0.0159000000000000;0.0150000000000000;0.0141000000000000;0.0133000000000000;0.0126000000000000;0.0119000000000000;0.0112000000000000;0.0106000000000000;0.0100000000000000;0.00944000000000000;0.00891000000000000;0.00841000000000000;0.00794000000000000;0.00750000000000000;0.00708000000000000;0.00668000000000000;0.00631000000000000;0.00596000000000000;0.00562000000000000;0.00531000000000000;0.00501000000000000;0.00473000000000000;0.00447000000000000;0.00422000000000000;0.00398000000000000;0.00376000000000000;0.00355000000000000;0.00335000000000000;0.00316000000000000;0.00299000000000000;0.00282000000000000;0.00266000000000000;0.00251000000000000;0.00237000000000000;0.00224000000000000;0.00211000000000000;0.00200000000000000;0.00188000000000000;0.00178000000000000;0.00168000000000000;0.00159000000000000;0.00150000000000000;0.00141000000000000;0.00133000000000000;0.00126000000000000;0.00119000000000000;0.00112000000000000;0.00106000000000000;0.00100000000000000]*1e-6;
% lambdas = flipud(lambdas);
vs = c ./ lambdas;
Bvs = zeros(size(vs));

for ( i = 1 : length(lambdas) )
    % black body radiation
    Bvs(i) = 2*h*vs(i)^3/c^2 / ( exp(h*vs(i)/(kB*T_star)) - 1 );
end

%% Find spectral flux at orbital distance
Fvs = Bvs * ( R_star / r_orb )^2 * pi;

Qs = [1.38000000000000e-05;1.55000000000000e-05;1.74000000000000e-05;1.95000000000000e-05;2.19000000000000e-05;2.46000000000000e-05;2.76000000000000e-05;3.09000000000000e-05;3.47000000000000e-05;3.89000000000000e-05;4.37000000000000e-05;4.90000000000000e-05;5.50000000000000e-05;6.17000000000000e-05;6.93000000000000e-05;7.78000000000000e-05;8.73000000000000e-05;9.80000000000000e-05;0.000110000000000000;0.000124000000000000;0.000139000000000000;0.000156000000000000;0.000175000000000000;0.000196000000000000;0.000220000000000000;0.000248000000000000;0.000278000000000000;0.000312000000000000;0.000351000000000000;0.000394000000000000;0.000443000000000000;0.000498000000000000;0.000560000000000000;0.000630000000000000;0.000709000000000000;0.000798000000000000;0.000899000000000000;0.00101000000000000;0.00114000000000000;0.00129000000000000;0.00145000000000000;0.00164000000000000;0.00185000000000000;0.00208000000000000;0.00235000000000000;0.00266000000000000;0.00301000000000000;0.00340000000000000;0.00385000000000000;0.00436000000000000;0.00493000000000000;0.00557000000000000;0.00630000000000000;0.00711000000000000;0.00803000000000000;0.00905000000000000;0.0102000000000000;0.0115000000000000;0.0128000000000000;0.0143000000000000;0.0161000000000000;0.0182000000000000;0.0206000000000000;0.0233000000000000;0.0264000000000000;0.0298000000000000;0.0339000000000000;0.0386000000000000;0.0442000000000000;0.0492000000000000;0.0495000000000000;0.0451000000000000;0.0386000000000000;0.0327000000000000;0.0294000000000000;0.0351000000000000;0.0464000000000000;0.0616000000000000;0.0802000000000000;0.106000000000000;0.129000000000000;0.145000000000000;0.108000000000000;0.0698000000000000;0.0324000000000000;0.0144000000000000;0.0113000000000000;0.0112000000000000;0.0111000000000000;0.0109000000000000;0.0107000000000000;0.0107000000000000;0.0108000000000000;0.0111000000000000;0.0115000000000000;0.0119000000000000;0.0124000000000000;0.0129000000000000;0.0134000000000000;0.0139000000000000;0.0143000000000000;0.0149000000000000;0.0155000000000000;0.0161000000000000;0.0168000000000000;0.0176000000000000;0.0185000000000000;0.0194000000000000;0.0204000000000000;0.0215000000000000;0.0227000000000000;0.0240000000000000;0.0255000000000000;0.0271000000000000;0.0289000000000000;0.0308000000000000;0.0329000000000000;0.0353000000000000;0.0380000000000000;0.0409000000000000;0.0442000000000000;0.0479000000000000;0.0519000000000000;0.0564000000000000;0.0613000000000000;0.0668000000000000;0.0729000000000000;0.0797000000000000;0.0873000000000000;0.0958000000000000;0.106000000000000;0.117000000000000;0.131000000000000;0.149000000000000;0.171000000000000;0.200000000000000;0.231000000000000;0.256000000000000;0.263000000000000;0.257000000000000;0.257000000000000;0.281000000000000;0.342000000000000;0.409000000000000;0.397000000000000;0.366000000000000;0.422000000000000;0.641000000000000;0.717000000000000;1.05000000000000;1.29000000000000;1.43000000000000;1.42000000000000;1.39000000000000;1.36000000000000;1.34000000000000;1.31000000000000;1.29000000000000;1.26000000000000;1.23000000000000;1.20000000000000;1.18000000000000;1.16000000000000;1.14000000000000;1.10000000000000;1.06000000000000;1.01000000000000;0.946000000000000;0.873000000000000;0.838000000000000;0.900000000000000;0.923000000000000;0.935000000000000;0.941000000000000;0.943000000000000;0.943000000000000;0.942000000000000;0.939000000000000;0.936000000000000;0.932000000000000;0.928000000000000;0.924000000000000;0.920000000000000;0.916000000000000;0.913000000000000;0.909000000000000;0.911000000000000;0.908000000000000;0.907000000000000;0.917000000000000;0.909000000000000;0.904000000000000;0.899000000000000;0.894000000000000;0.888000000000000;0.890000000000000;0.888000000000000;0.878000000000000;0.868000000000000;0.907000000000000;0.891000000000000;0.877000000000000;0.863000000000000;0.846000000000000;0.828000000000000;0.807000000000000;0.806000000000000;0.782000000000000;0.755000000000000;0.726000000000000;0.695000000000000;0.662000000000000;0.627000000000000;0.591000000000000;0.555000000000000;0.518000000000000;0.481000000000000;0.444000000000000;0.408000000000000;0.373000000000000;0.340000000000000;0.308000000000000;0.277000000000000;0.247000000000000;0.221000000000000;0.196000000000000;0.398000000000000;0.366000000000000;0.333000000000000;0.301000000000000;0.270000000000000;0.241000000000000;0.354000000000000;0.318000000000000;0.311000000000000;0.279000000000000;0.249000000000000;0.221000000000000;0.195000000000000;0.171000000000000;0.149000000000000];
FQs = (Fvs .* Qs);
Pin_total = (1e-5)^2 * pi * trapz(vs,FQs);

%% Plot result
figure(fnum); clf(fnum);
plot(lambdas*1e6,Fvs,'-'); 
grid on; hold on;
plot(lambdas*1e6,FQs,'r-');
xlabel('wavelength [\mum]');
ylabel('flux density [Jy]');

legend('emitted from star','absorbed by dust');

end